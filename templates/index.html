<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JUNGLE DUNK - HOME</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- flatpickr CSS/JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- ìº˜ë¦°ë” ìŠ¤íƒ€ì¼ ì˜¤ë²„ë¼ì´ë“œ -->
    <style>
        .flatpickr-calendar.inline {
            position: static !important;
            max-width: none !important;
            left: auto !important;
            margin: 0 !important;
            transform: scale(1) !important;
            transform-origin: top right !important;
        }

        @media (min-width: 1024px) {
            .flatpickr-calendar.inline {
                transform: scale(1.5) !important;
            }
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">

    <!-- ìƒë‹¨ ì˜ì—­: ë¡œê³  + ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="flex flex-col items-center pt-8">
        <!-- ë¡œê³  -->
        <div class="mb-4">
            <a href="/">
                <img src="{{ url_for('static', filename='jungledunk.png') }}" alt="Jungle Dunk Logo"
                    class="h-20 w-auto mx-auto" />
            </a>
        </div>

        <!-- ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¥¸ ë²„íŠ¼ -->
        <div id="nav-center" class="flex items-center space-x-2 mb-8">
            <!-- ê²ŒìŠ¤íŠ¸ ìƒíƒœ -->
            <div id="guest-buttons" class="flex space-x-2">
                <a href="/login" class="px-3 py-1 bg-[#15857A] text-white rounded shadow hover:bg-[#15857A]">ë¡œê·¸ì¸</a>
                <a href="/register" class="px-3 py-1 bg-blue-500 text-white rounded shadow hover:bg-blue-600">íšŒì›ê°€ì…</a>
            </div>
            <!-- ë¡œê·¸ì¸ ëœ ìƒíƒœ -->
            <div id="user-buttons" class="hidden flex items-center space-x-2">
                <span id="username-display" class="text-sm font-bold text-gray-800"></span>
                <a href="/reservations"
                    class="px-3 py-1 bg-yellow-500 text-white rounded shadow hover:bg-yellow-600 text-sm">ë‚´ ì˜ˆì•½í˜„í™©</a>
                <button onclick="logout()"
                    class="px-3 py-1 bg-red-500 text-white rounded shadow hover:bg-red-600 text-sm">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ: ì¢Œìš° ë°°ì¹˜ (main.htmlì—ì„œ ê°€ì ¸ì˜´) -->
    <div class="w-full flex flex-col lg:flex-row items-start px-4 space-y-4 lg:space-y-0 lg:space-x-4 lg:mt-12">
        <!-- ì˜ˆì•½ ë°ì´í„° ì˜ì—­ (ì™¼ìª½) -->
        <div id="data-container-wrapper" class="w-full lg:w-1/2 relative order-2 lg:order-1 bg-gray p-4 ">
            <div id="data-container" class="text-xl md:text-2xl font-bold">
                ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.
            </div>
            <!-- ê³ ì •ëœ + ë²„íŠ¼ -->
            <button class="fixed bottom-8 right-8 bg-orange-500 text-white rounded-full shadow-lg 
           hover:bg-blue-600 w-16 h-16 flex items-center justify-center text-5xl font-bold leading-none"
                onclick="navigateIfLoggedIn('/recruitment')">
                <span class="translate-y-[-5px]">+</span>
            </button>
        </div>

        <!-- ìº˜ë¦°ë” ì˜ì—­ (ì˜¤ë¥¸ìª½) -->
        <div class="w-full lg:w-1/2 p-4 order-1 lg:order-2 lg:min-w-[400px]">
            <div class="p-4 flex justify-center lg:justify-end transform -translate-y-20">
                <div id="calendar"></div>
            </div>
        </div>

        <!-- ì•„ë˜ìª½ ì—¬ë°± -->
        <div class="mb-12"></div>
    </div>

    <script>
        // JWT í† í° í™•ì¸ í›„ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìƒíƒœ ë³€ê²½
        document.addEventListener("DOMContentLoaded", function () {
            const token = localStorage.getItem("token");
            if (token) {
                const payload = JSON.parse(atob(token.split(".")[1]));
                const username = payload.username;
                document.getElementById("username-display").textContent = `${username}ë‹˜!`;
                document.getElementById("guest-buttons").classList.add("hidden");
                document.getElementById("user-buttons").classList.remove("hidden");
            }
        });

        function logout() {
            localStorage.removeItem("token");
            alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤!");
            location.reload();
        }
        // ë¡œê·¸ì¸ ì—¬ë¶€ì— ë”°ë¼ targetUrl ë˜ëŠ” /loginìœ¼ë¡œ ì´ë™í•˜ëŠ” í•¨ìˆ˜
        function navigateIfLoggedIn(targetUrl) {
            const token = localStorage.getItem('token');
            if (token) {
                window.location.href = targetUrl;
            } else {
                window.location.href = '/login';
            }
        }

        function selectDate(dateStr) {
            const dataContainer = document.getElementById('data-container');

            fetch(`/get_matches?date=${dateStr}`)
                .then(response => response.json())
                .then(data => {
                    let matches = data.matches || [];

                    // í˜„ì¬ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ì•„ì§ ì§„í–‰ ì¤‘(ë˜ëŠ” ì‹œì‘ ì „)ì¸ ë§¤ì¹˜ë§Œ í•„í„°ë§
                    const now = new Date();
                    matches = matches.filter(match => {
                        const matchEndDateTime = new Date(match.date + ' ' + match.time_end);
                        return matchEndDateTime >= now;
                    });

                    // ì„ íƒí•œ ë‚ ì§œë¥¼ í‘œì‹œí•˜ëŠ” í—¤ë” ì¶”ê°€ (ìŒìˆ˜ ë§ˆì§„ ì œê±°)
                    let html = `<div class="text-center mt-[-100px] mb-2 font-bold text-xl">${dateStr}</div>`;

                    if (matches.length === 0) {
                        html += `<div class="p-4 bg-white border border-gray-300 text-gray-700 text-center rounded-lg shadow-md min-h-[100px]">
                            ì•„ì§ ì˜ˆì•½ì´ ì—†ì–´ìš”.<br>ì˜ˆì•½í•˜ì‹œë ¤ë©´ ì•„ë˜ <span class="font-bold text-orange-500">+ ë²„íŠ¼</span>ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
                         </div>`;
                    } else {
                        matches.forEach((match) => {
                            const isFull = match.current_players === match.max_players;
                            html += `
            <div class="space-y-4">
                <button onclick="navigateIfLoggedIn('/comment?match_id=${match.match_id}')"
    class="w-full text-left relative bg-white border border-gray-300 shadow-lg rounded-xl p-5 flex flex-col md:flex-row md:items-center items-center
    ${isFull ? 'opacity-50 cursor-not-allowed' : 'hover:shadow-xl transition duration-300 ease-in-out'}"
    ${isFull ? 'disabled' : ''}>
  
                ${isFull
                                    ? `<div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-60 text-white text-lg font-bold rounded-xl">
                          ğŸš« ì´ë¯¸ ë§ˆê°ë¨
                       </div>`
                                    : ''
                                }
  
                <div class="flex-none text-lg font-bold whitespace-nowrap md:pr-12 text-gray-900 text-left">
                    â° ${match.time_start} ~ ${match.time_end}
                </div>
  
                <div class="w-2/4 text-base text-gray-700 ml-4 text-left">
                    <p class="font-semibold">ğŸ‘¥ ì¸ì›: ${match.current_players} / ${match.max_players}</p>
                    <p class="text-gray-600">ğŸ€ #${match.court_type} , âœï¸ #${match.memo}</p>
                    <p class="text-sm text-gray-500 font-medium">ğŸ“Œ ì˜ˆì•½ì: ${match.creator_name}</p>
                </div>
              </button>
            </div>
        `;
                        });
                    }
                    dataContainer.innerHTML = html;
                })
                .catch(error => {
                    console.error("ì˜ˆì•½ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                    dataContainer.innerHTML = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                });
        }

        document.addEventListener("DOMContentLoaded", function () {
            fetch('/get_reserved_dates')
                .then(response => response.json())
                .then(data => {
                    const reservedDates = data.reserved_dates || [];

                    console.log("ğŸ¨ ì˜ˆì•½ëœ ë‚ ì§œ ëª©ë¡:", reservedDates);

                    flatpickr("#calendar", {
                        dateFormat: "Y-m-d",
                        locale: "ko",
                        inline: true,
                        disableMobile: true,
                        minDate: 'today',
                        onChange: function (selectedDates, dateStr) {
                            if (selectedDates.length > 0) {
                                console.log("ğŸ“… ì„ íƒí•œ ë‚ ì§œ:", dateStr);
                                selectDate(dateStr);
                            }
                        },
                        onDayCreate: function (dObj, dStr, fp, dayElem) {
                            const dateObj = dayElem.dateObj;
                            const dateStr = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${String(dateObj.getDate()).padStart(2, '0')}`;

                            console.log("ğŸ” ë‹¬ë ¥ ìƒì„± ë‚ ì§œ:", dateStr);

                            if (reservedDates.includes(dateStr)) {
                                console.log("âœ… ì˜ˆì•½ëœ ë‚ ì§œ:", dateStr);

                                // ê¸°ì¡´ Tailwind í´ë˜ìŠ¤ë¥¼ ìœ ì§€í•˜ë©´ì„œ ì˜ˆì•½ëœ ë‚ ì§œì— ìŠ¤íƒ€ì¼ ì ìš©
                                dayElem.classList.add(
                                    "bg-[#FF6A3B]",
                                    "rounded-full",
                                    "text-black",
                                    "font-bold",
                                    "border",
                                    "border-[#FF6A3B]",
                                    "flex",
                                    "items-center",
                                    "justify-center"
                                );
                            }
                        }

                    });

                    // ì´ˆê¸° ë‚ ì§œ ì„¤ì • (ì˜¤ëŠ˜ ë‚ ì§œ)
                    const today = new Date();
                    const todayDateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                    selectDate(todayDateStr);
                })
                .catch(error => {
                    console.error("âŒ ì˜ˆì•½ëœ ë‚ ì§œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
                });
        });

        // ì´ˆê¸° ë°ì´í„° ì„¤ì • (ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ì¤€)
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, "0");
        const dd = String(today.getDate()).padStart(2, "0");
        const todayDateStr = `${yyyy}-${mm}-${dd}`;
        selectDate(todayDateStr);

    </script>

</body>

</html>