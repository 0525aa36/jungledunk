<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>예약 시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>

        function logout() {
            localStorage.removeItem("token");  // JWT 토큰 삭제
            alert("로그아웃 되었습니다!");
            window.location.href = "/";  // index.html로 이동
        }

        function openPopup(reservationId) {
            document.getElementById('popup').classList.remove('hidden');
            document.getElementById('confirmDelete').setAttribute('data-id', reservationId);
        }

        function closePopup() {
            document.getElementById('popup').classList.add('hidden');
            document.getElementById('deleteReason').value = ""; // 입력 초기화
        }

        function deleteReservation() {
        let reason = document.getElementById('deleteReason').value;
        if (reason.trim() === '') {
          alert('삭제 사유를 입력해주세요.');
          return;
        document.addEventListener("DOMContentLoaded", function () {
            const token = localStorage.getItem("token");

            if (token) {
                const payload = JSON.parse(atob(token.split(".")[1])); // JWT 토큰 디코딩
                const username = payload.username;

                // 로그인된 사용자 이름을 네비게이션에 반영
                document.getElementById("user-name").textContent = `${username}님`;
            }
        });

        function openConfirmPopup() {
            document.getElementById('confirmPopup').classList.remove('hidden');
        }

        function closeConfirmPopup() {
            document.getElementById('confirmPopup').classList.add('hidden');
        }
        // match id는 confirmDelete 버튼의 data-id 속성에 저장되어 있음
        const matchId = document
          .getElementById('confirmDelete')
          .getAttribute('data-id');

        // API 호출: 주최자 삭제 (match 취소)
        fetch('/cancel_match/' + matchId, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ reason: reason }),
        })
          .then((response) => response.json())
          .then((data) => {
            alert(data.message);
            closeConfirmPopup();
            // 삭제 후 예약 목록 새로고침 등 추가 처리
          })
          .catch((err) => {
            console.error(err);
            alert('삭제에 실패했습니다.');
          });
      }

      function openConfirmPopup() {
        document.getElementById('confirmPopup').classList.remove('hidden');
      }

      function closeConfirmPopup() {
        document.getElementById('confirmPopup').classList.add('hidden');
      }
          
      function closeCancelPopup() {
            document.getElementById('cancelPopup').classList.add('hidden');
        }
          
      function openCancelPopup(reservationId) {
        document.getElementById('cancelPopup').classList.remove('hidden');
        document
          .getElementById('confirmCancel')
          .setAttribute('data-id', reservationId);
      }
      
    </script>
</head>

  <body class="bg-gray-100 flex justify-center items-center min-h-screen">
    <div class="w-full max-w-md p-6">
      <!-- 상단 네비게이션 -->
      <div class="text-right mb-4 text-gray-600">
        <span>방호석님</span> |
        <a href="#" class="hover:underline">로그아웃</a>
      </div>


      <!-- 타이틀 -->
      <div
        class="bg-gray-300 text-lg font-bold px-6 py-3 rounded-lg text-center"
      >
        내 예약현황
      </div>

      <!-- 예약 리스트 -->
      <div class="mt-6 space-y-4">
        {% for res in reservations %} {% set match = res.match %}
        <div
          class="bg-white border border-gray-300 shadow-md rounded-lg p-4 flex justify-between items-center"
        >
          <div class="w-1/4 text-left">
            <p class="text-lg font-semibold text-gray-800">
              {{ match.time_start }} ~ {{ match.time_end }}
            </p>
          </div>
          <div class="w-2/4 text-sm text-gray-700">
            <p>인원 : {{ match.current_players }}/{{ match.max_players }}</p>
            <p>#{{ match.court_type }} #{{ match.memo }}</p>
            <p class="text-xs text-gray-500">예약자: {{ match.creator_id }}</p>
          </div>
          <div class="w-1/4 flex flex-col items-end space-y-2">
            {% if match.creator_id == current_user_id %}
            <!-- 내가 만든 match: 삭제하기, 예약자 명단 -->
            <button
              onclick="openPopup('{{ match._id }}')"
              class="bg-orange-500 text-white w-full text-center px-4 py-2 text-sm rounded-lg hover:bg-orange-600 transition"
            >
              삭제하기
            </button>
            <a href="/player_list/{{ match._id }}"
              class="bg-orange-500 text-white w-full text-center px-4 py-2 text-sm rounded-lg hover:bg-orange-600 transition"
              >예약자 명단</a
            >
            {% else %}
            <!-- 내가 만든 match가 아닌 경우: 취소하기 -->
            <button
              onclick="openCancelPopup('{{ match._id }}', '{{ res.reservation_id }}')"
              class="bg-orange-500 text-white w-full text-center px-4 py-2 text-sm rounded-lg hover:bg-orange-600 transition"
            >
              취소하기
            </button>
            {% endif %}
          </div>
        </div>
        {% else %}
        <p class="text-center text-gray-500">예약 내역이 없습니다.</p>
        {% endfor %}
      </div>
    </div>

    <!-- 삭제 확인 팝업 -->
    <div
      id="popup"
      class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center"
    >
      <div class="bg-white p-6 rounded-lg shadow-lg w-80 text-center">
        <p class="text-lg font-semibold">정말 삭제하시겠습니까?</p>
        <textarea
          id="deleteReason"
          class="w-full border rounded-lg p-2 mt-2"
          placeholder="삭제 사유를 입력하세요..."
        ></textarea>
        <div class="mt-4 flex justify-center space-x-4">
          <button
            id="confirmDelete"
            onclick="deleteReservation()"
            class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition"
          >
            확인
          </button>
          <button
            onclick="closePopup()"
            class="bg-gray-300 px-4 py-2 rounded-lg hover:bg-gray-400 transition"
          >
            취소
          </button>
        </div>
      </div>
    </div>

    <!-- 삭제 완료 팝업 -->
    <div
      id="confirmPopup"
      class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center"
    >
      <div class="bg-white p-6 rounded-lg shadow-lg w-80 text-center">
        <p class="text-lg font-semibold">삭제되었습니다.</p>
        <p class="text-sm text-gray-600 mt-2">삭제 사유:</p>
        <p
          id="deleteReasonText"
          class="text-sm text-gray-800 font-medium mt-1"
        ></p>
        <div class="mt-4 flex justify-center">
          <button
            onclick="closeConfirmPopup()"
            class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition"
          >
            확인
          </button>
        </div>
      </div>
    </div>

    <!-- 예약 취소 팝업 -->
    <div
      id="cancelPopup"
      class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center"
    >
      <div class="bg-white p-6 rounded-lg shadow-lg w-80 text-center">
        <p class="text-lg font-semibold">정말 예약을 취소하시겠습니까?</p>
        <div class="mt-4 flex justify-center space-x-4">
          <button
            id="confirmCancel"
            onclick="closeCancelPopup()"
            class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition"
          >
            확인
          </button>
          <button
            onclick="closeCancelPopup()"
            class="bg-gray-300 px-4 py-2 rounded-lg hover:bg-gray-400 transition"
          >
            취소
          </button>
        </div>
      </div>
    </div>
  </body>
</html>
