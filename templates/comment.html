<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <title>ë§¤ì¹˜ ìƒì„¸ í˜ì´ì§€</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen">

    <!-- ìƒë‹¨ ì˜ì—­: ë¡œê³  + ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="flex flex-col items-center pt-8">
        <!-- ë¡œê³  -->
        <div class="mb-4">
            <img src="{{ url_for('static', filename='jungledunk.png') }}" alt="Jungle Dunk Logo"
                class="h-20 w-auto mx-auto" />
        </div>
        <!-- ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¥¸ ë²„íŠ¼ -->
        <div id="nav-center" class="flex items-center space-x-2 mb-8">
            <!-- ê²ŒìŠ¤íŠ¸ ìƒíƒœ -->
            <div id="guest-buttons" class="flex space-x-2">
                <a href="/login" class="px-3 py-1 bg-[#15857A] text-white rounded shadow hover:bg-[#15857A]">ë¡œê·¸ì¸</a>
                <a href="/register" class="px-3 py-1 bg-blue-500 text-white rounded shadow hover:bg-blue-600">íšŒì›ê°€ì…</a>
            </div>
            <!-- ë¡œê·¸ì¸ ëœ ìƒíƒœ -->
            <div id="user-buttons" class="hidden flex items-center space-x-2">
                <span id="username-display" class="text-sm font-bold text-gray-800"></span>
                <a href="/reservations"
                    class="px-3 py-1 bg-yellow-500 text-white rounded shadow hover:bg-yellow-600 text-sm">ë‚´ ì˜ˆì•½í˜„í™©</a>
                <button onclick="logout()"
                    class="px-3 py-1 bg-red-500 text-white rounded shadow hover:bg-red-600 text-sm">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </div>
    <!-- ë§¤ì¹˜ ìƒì„¸ ì •ë³´ ì˜ì—­ -->
    <main class="flex-1 flex flex-col items-center mt-8 px-4">
        <section class="bg-white w-full max-w-xl p-6 rounded-lg shadow-md">
            <!-- ì‹¤ì œ ì˜ˆì•½ ë°ì´í„°ë¥¼ ë™ì ìœ¼ë¡œ ì±„ì›Œ ë„£ì„ ìˆ˜ ìˆìŒ -->
            <div class="mb-4">
                <h2 id="matchTime" class="text-xl font-bold">10:00 ~ 11:30</h2>
                <p id="matchParticipants" class="mt-2">ì¸ì›: <span class="font-semibold">3/6</span></p>
                <p id="matchMemo" class="mt-2">#í’€ì½”íŠ¸ #ë¨¹ê³ ìŒë£Œë‚´ê¸°</p>
            </div>
            <!-- ì‹ ì²­í•˜ê¸° ë²„íŠ¼: ì‹¤ì œ ì¸ì›ìˆ˜ì— ë”°ë¼ ì˜ˆì•½ ê°€ëŠ¥ ì—¬ë¶€ë¥¼ ì „ë‹¬ -->
            <button id="applyButton" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">ì‹ ì²­í•˜ê¸°</button>

        </section>

        <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
        <section class="bg-white w-full max-w-xl p-6 rounded-lg shadow-md mt-6">
            <h3 class="text-lg font-bold mb-4">ëŒ“ê¸€</h3>

            <!-- ê¸°ì¡´ ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ -->
            <div id="commentList" class="space-y-2 mb-4">
                <!-- ëŒ“ê¸€ ëª©ë¡ì´ ì—¬ê¸°ì— ì±„ì›Œì§‘ë‹ˆë‹¤ -->
            </div>

            <!-- ëŒ“ê¸€ ì…ë ¥ -->
            <div class="flex space-x-2">
                <input type="text" id="commentInput" class="flex-1 border rounded px-3 py-2" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”." />
                <button onclick="addComment()"
                    class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">ì…ë ¥</button>
            </div>
        </section>
    </main>

    <!-- ì¸ì› ê½‰ ì°¸ íŒì—… -->
    <div id="fullPopup" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center">
        <div class="bg-white p-6 rounded-lg shadow-lg w-80 text-center">
            <p class="text-lg font-semibold">ì‹ ì²­ ë¶ˆê°€</p>
            <p class="text-sm text-gray-600 mt-2">í•´ë‹¹ ê²½ê¸°ëŠ” ì´ë¯¸ ì¸ì›ì´ ë‹¤ ì°¼ìŠµë‹ˆë‹¤.</p>
            <div class="mt-4 flex justify-center">
                <button onclick="closeFullPopup()"
                    class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">í™•ì¸</button>
            </div>
        </div>
    </div>

    <!-- ì‹ ì²­ ì™„ë£Œ íŒì—… -->
    <div id="successPopup" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center">
        <div class="bg-white p-6 rounded-lg shadow-lg w-80 text-center">
            <p class="text-lg font-semibold">ì‹ ì²­ ì™„ë£Œ</p>
            <p class="text-sm text-gray-600 mt-2">ë§¤ì¹˜ ì˜ˆì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            <div class="mt-4 flex justify-center">
                <button onclick="closeSuccessPopup()"
                    class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">í™•ì¸</button>
            </div>
        </div>
    </div>

    <script>
        // JWT í† í° í™•ì¸ í›„ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìƒíƒœ ë³€ê²½
        document.addEventListener("DOMContentLoaded", function () {
            const token = localStorage.getItem("token");
            if (token) {
                const payload = JSON.parse(atob(token.split(".")[1]));
                const username = payload.username;
                document.getElementById("username-display").textContent = `${username}ë‹˜!`;
                document.getElementById("guest-buttons").classList.add("hidden");
                document.getElementById("user-buttons").classList.remove("hidden");
            }
        });
        // URLì—ì„œ match_id ê°€ì ¸ì˜¤ê¸°
        function getMatchIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const matchId = params.get('match_id');
            console.log("ğŸ›  URLì—ì„œ ê°€ì ¸ì˜¨ match_id:", matchId); // ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
            return matchId;
        }

        // ì˜ˆì•½ ì‹ ì²­ í•¨ìˆ˜ (ì‹ ì²­ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰)
        function applyMatch(matchId, currentParticipants, maxParticipants) {
            console.log("âœ… applyMatch() í˜¸ì¶œë¨! matchId:", matchId, "íƒ€ì…:", typeof matchId);

            if (!matchId) {
                alert("âŒ matchIdê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            if (currentParticipants >= maxParticipants) {
                openFullPopup();
            } else {
                const token = localStorage.getItem("token");
                if (!token) {
                    window.location.href = '/login';
                    return;
                }

                const payload = JSON.parse(atob(token.split('.')[1]));
                const user_id = payload.username;  // JWTì—ì„œ username ì¶”ì¶œ

                fetch('/create_reservation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ match_id: String(matchId), user_id: user_id }) // match_idë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ì „ì†¡
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message === 'ì˜ˆì•½ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!') {
                            openSuccessPopup();
                            loadMatchDetails();  // ì˜ˆì•½ ì¸ì› ì—…ë°ì´íŠ¸
                        } else {
                            alert(data.message);
                        }
                    })
                    .catch(error => {
                        console.error("âŒ ì˜ˆì•½ ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                    });
            }
        }




        // ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜
        function loadComments() {
            const matchId = getMatchIdFromUrl();
            if (!matchId) {
                console.error("âŒ match_idê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            console.log(`ğŸ›  ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°: match_id=${matchId}`);

            fetch(`/get_comments?match_id=${matchId}`)
                .then(response => response.json())
                .then(data => {
                    const commentList = document.getElementById("commentList");
                    if (!commentList) {
                        console.error("âŒ commentList ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                        return;
                    }

                    if (data.comments.length === 0) {
                        commentList.innerHTML = '<p class="text-gray-500">ë“±ë¡ëœ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    } else {
                        let html = '';
                        data.comments.forEach(comment => {
                            html += `<div class="bg-gray-50 p-2 rounded mb-2">
                                <span class="font-semibold">${comment.user_id}:</span> ${comment.content}
                             </div>`;
                        });
                        commentList.innerHTML = html;
                    }
                })
                .catch(error => {
                    console.error("âŒ ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error);
                });
        }


        // ëŒ“ê¸€ ì‘ì„± í•¨ìˆ˜
        function addComment() {
            const matchId = getMatchIdFromUrl();
            const commentInput = document.getElementById("commentInput");
            const content = commentInput.value.trim();
            if (!content) {
                alert("ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”.");
                return;
            }

            const token = localStorage.getItem("token");
            if (!token) {
                window.location.href = '/login';
                return;
            }

            const payload = JSON.parse(atob(token.split('.')[1]));
            const user_id = payload.username;  // JWTì—ì„œ username ì¶”ì¶œ

            fetch('/add_comment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ match_id: matchId, user_id: user_id, content: content })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.message === 'ëŒ“ê¸€ ë“±ë¡ ì„±ê³µ!') {
                        commentInput.value = '';
                        loadComments();  // ğŸš€ ëŒ“ê¸€ ì¶”ê°€ í›„ ëª©ë¡ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error("âŒ ëŒ“ê¸€ ë“±ë¡ ì˜¤ë¥˜:", error);
                });
        }



        // íŠ¹ì • ë§¤ì¹˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì™€ í™”ë©´ì— í‘œì‹œ
        function loadMatchDetails() {
            const matchId = getMatchIdFromUrl();
            if (!matchId) {
                alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤. match_idê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            fetch(`/get_match?match_id=${matchId}`)
                .then(response => response.json())
                .then(match => {
                    if (match.message) {
                        alert(match.message);
                        return;
                    }

                    // HTML ìš”ì†Œ ì—…ë°ì´íŠ¸
                    document.getElementById("matchTime").innerText = `${match.time_start} ~ ${match.time_end}`;
                    document.getElementById("matchParticipants").innerHTML = `ì¸ì›: <span class="font-semibold">${match.current_players}/${match.max_players}</span>`;
                    document.getElementById("matchMemo").innerText = `#${match.court_type} #${match.memo}`;

                    // ğŸ›  applyButtonì„ ê°€ì ¸ì™€ì„œ matchIdë¥¼ ì„¤ì •
                    setTimeout(() => {
                        const applyButton = document.getElementById("applyButton");
                        if (applyButton) {
                            console.log("âœ… applyButton ìš”ì†Œ ì°¾ìŒ");
                            applyButton.setAttribute("onclick", `applyMatch('${match.match_id}', ${match.current_players}, ${match.max_players})`);
                        } else {
                            console.error("âŒ applyButton ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                        }
                    }, 500);  // ë²„íŠ¼ì´ ë Œë”ë§ë  ì‹œê°„ì„ í™•ë³´
                })
                .catch(error => {
                    console.error("âŒ ë§¤ì¹˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                });
        }



        function openFullPopup() {
            document.getElementById('fullPopup').classList.remove('hidden');
        }

        function closeFullPopup() {
            document.getElementById('fullPopup').classList.add('hidden');
        }

        function openSuccessPopup() {
            document.getElementById('successPopup').classList.remove('hidden');
        }

        function closeSuccessPopup() {
            document.getElementById('successPopup').classList.add('hidden');
        }

        document.addEventListener("DOMContentLoaded", function () {
            loadMatchDetails();  // ë§¤ì¹˜ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
            loadComments();  // ğŸš€ í˜ì´ì§€ ë¡œë“œ ì‹œ ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì¶”ê°€
        });

    </script>
</body>

</html>