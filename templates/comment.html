<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <title>매치 상세 페이지</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen">

    <!-- 상단 영역: 로고 + 네비게이션 -->
    <div class="flex flex-col items-center pt-8">
        <!-- 로고 -->
        <div class="mb-4">
            <img src="{{ url_for('static', filename='jungledunk.png') }}" alt="Jungle Dunk Logo"
                class="h-20 w-auto mx-auto" />
        </div>
        <!-- 로그인 상태에 따른 버튼 -->
        <div id="nav-center" class="flex items-center space-x-2 mb-8">
            <!-- 게스트 상태 -->
            <div id="guest-buttons" class="flex space-x-2">
                <a href="/login" class="px-3 py-1 bg-[#15857A] text-white rounded shadow hover:bg-[#15857A]">로그인</a>
                <a href="/register" class="px-3 py-1 bg-blue-500 text-white rounded shadow hover:bg-blue-600">회원가입</a>
            </div>
            <!-- 로그인 된 상태 -->
            <div id="user-buttons" class="hidden flex items-center space-x-2">
                <span id="username-display" class="text-sm font-bold text-gray-800"></span>
                <a href="/reservations"
                    class="px-3 py-1 bg-yellow-500 text-white rounded shadow hover:bg-yellow-600 text-sm">내 예약현황</a>
                <button onclick="logout()"
                    class="px-3 py-1 bg-red-500 text-white rounded shadow hover:bg-red-600 text-sm">로그아웃</button>
            </div>
        </div>
    </div>
    <!-- 매치 상세 정보 영역 -->
    <main class="flex-1 flex flex-col items-center mt-8 px-4">
        <section class="bg-white w-full max-w-xl p-6 rounded-lg shadow-md">
            <!-- 실제 예약 데이터를 동적으로 채워 넣을 수 있음 -->
            <div class="mb-4">
                <h2 id="matchTime" class="text-xl font-bold">10:00 ~ 11:30</h2>
                <p id="matchParticipants" class="mt-2">인원: <span class="font-semibold">3/6</span></p>
                <p id="matchMemo" class="mt-2">#풀코트 #먹고음료내기</p>
            </div>
            <!-- 신청하기 버튼: 실제 인원수에 따라 예약 가능 여부를 전달 -->
            <button id="applyButton" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">신청하기</button>

        </section>

        <!-- 댓글 섹션 -->
        <section class="bg-white w-full max-w-xl p-6 rounded-lg shadow-md mt-6">
            <h3 class="text-lg font-bold mb-4">댓글</h3>

            <!-- 기존 댓글 리스트 -->
            <div id="commentList" class="space-y-2 mb-4">
                <!-- 댓글 목록이 여기에 채워집니다 -->
            </div>

            <!-- 댓글 입력 -->
            <div class="flex space-x-2">
                <input type="text" id="commentInput" class="flex-1 border rounded px-3 py-2" placeholder="댓글을 입력하세요." />
                <button onclick="addComment()"
                    class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">입력</button>
            </div>
        </section>
    </main>

    <!-- 인원 꽉 참 팝업 -->
    <div id="fullPopup" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center">
        <div class="bg-white p-6 rounded-lg shadow-lg w-80 text-center">
            <p class="text-lg font-semibold">신청 불가</p>
            <p class="text-sm text-gray-600 mt-2">해당 경기는 이미 인원이 다 찼습니다.</p>
            <div class="mt-4 flex justify-center">
                <button onclick="closeFullPopup()"
                    class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">확인</button>
            </div>
        </div>
    </div>

    <!-- 신청 완료 팝업 -->
    <div id="successPopup" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center">
        <div class="bg-white p-6 rounded-lg shadow-lg w-80 text-center">
            <p class="text-lg font-semibold">신청 완료</p>
            <p class="text-sm text-gray-600 mt-2">매치 예약이 완료되었습니다.</p>
            <div class="mt-4 flex justify-center">
                <button onclick="closeSuccessPopup()"
                    class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">확인</button>
            </div>
        </div>
    </div>

    <script>
        // JWT 토큰 확인 후 네비게이션 버튼 상태 변경
        document.addEventListener("DOMContentLoaded", function () {
            const token = localStorage.getItem("token");
            if (token) {
                const payload = JSON.parse(atob(token.split(".")[1]));
                const username = payload.username;
                document.getElementById("username-display").textContent = `${username}님!`;
                document.getElementById("guest-buttons").classList.add("hidden");
                document.getElementById("user-buttons").classList.remove("hidden");
            }
        });
        // URL에서 match_id 가져오기
        function getMatchIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const matchId = params.get('match_id');
            console.log("🛠 URL에서 가져온 match_id:", matchId); // 디버깅 로그 추가
            return matchId;
        }

        // 예약 신청 함수 (신청 버튼 클릭 시 실행)
        function applyMatch(matchId, currentParticipants, maxParticipants) {
            console.log("✅ applyMatch() 호출됨! matchId:", matchId, "타입:", typeof matchId);

            if (!matchId) {
                alert("❌ matchId가 없습니다.");
                return;
            }

            if (currentParticipants >= maxParticipants) {
                openFullPopup();
            } else {
                const token = localStorage.getItem("token");
                if (!token) {
                    window.location.href = '/login';
                    return;
                }

                const payload = JSON.parse(atob(token.split('.')[1]));
                const user_id = payload.username;  // JWT에서 username 추출

                fetch('/create_reservation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ match_id: String(matchId), user_id: user_id }) // match_id를 문자열로 변환하여 전송
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message === '예약 신청이 완료되었습니다!') {
                            openSuccessPopup();
                            loadMatchDetails();  // 예약 인원 업데이트
                        } else {
                            alert(data.message);
                        }
                    })
                    .catch(error => {
                        console.error("❌ 예약 신청 중 오류 발생:", error);
                    });
            }
        }




        // 댓글 불러오기 함수
        function loadComments() {
            const matchId = getMatchIdFromUrl();
            if (!matchId) {
                console.error("❌ match_id가 없습니다.");
                return;
            }

            console.log(`🛠 댓글 불러오기: match_id=${matchId}`);

            fetch(`/get_comments?match_id=${matchId}`)
                .then(response => response.json())
                .then(data => {
                    const commentList = document.getElementById("commentList");
                    if (!commentList) {
                        console.error("❌ commentList 요소를 찾을 수 없습니다.");
                        return;
                    }

                    if (data.comments.length === 0) {
                        commentList.innerHTML = '<p class="text-gray-500">등록된 댓글이 없습니다.</p>';
                    } else {
                        let html = '';
                        data.comments.forEach(comment => {
                            html += `<div class="bg-gray-50 p-2 rounded mb-2">
                                <span class="font-semibold">${comment.user_id}:</span> ${comment.content}
                             </div>`;
                        });
                        commentList.innerHTML = html;
                    }
                })
                .catch(error => {
                    console.error("❌ 댓글 불러오기 오류:", error);
                });
        }


        // 댓글 작성 함수
        function addComment() {
            const matchId = getMatchIdFromUrl();
            const commentInput = document.getElementById("commentInput");
            const content = commentInput.value.trim();
            if (!content) {
                alert("댓글을 입력하세요.");
                return;
            }

            const token = localStorage.getItem("token");
            if (!token) {
                window.location.href = '/login';
                return;
            }

            const payload = JSON.parse(atob(token.split('.')[1]));
            const user_id = payload.username;  // JWT에서 username 추출

            fetch('/add_comment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ match_id: matchId, user_id: user_id, content: content })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.message === '댓글 등록 성공!') {
                        commentInput.value = '';
                        loadComments();  // 🚀 댓글 추가 후 목록 다시 불러오기
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error("❌ 댓글 등록 오류:", error);
                });
        }



        // 특정 매치 정보를 불러와 화면에 표시
        function loadMatchDetails() {
            const matchId = getMatchIdFromUrl();
            if (!matchId) {
                alert("잘못된 접근입니다. match_id가 없습니다.");
                return;
            }

            fetch(`/get_match?match_id=${matchId}`)
                .then(response => response.json())
                .then(match => {
                    if (match.message) {
                        alert(match.message);
                        return;
                    }

                    // HTML 요소 업데이트
                    document.getElementById("matchTime").innerText = `${match.time_start} ~ ${match.time_end}`;
                    document.getElementById("matchParticipants").innerHTML = `인원: <span class="font-semibold">${match.current_players}/${match.max_players}</span>`;
                    document.getElementById("matchMemo").innerText = `#${match.court_type} #${match.memo}`;

                    // 🛠 applyButton을 가져와서 matchId를 설정
                    setTimeout(() => {
                        const applyButton = document.getElementById("applyButton");
                        if (applyButton) {
                            console.log("✅ applyButton 요소 찾음");
                            applyButton.setAttribute("onclick", `applyMatch('${match.match_id}', ${match.current_players}, ${match.max_players})`);
                        } else {
                            console.error("❌ applyButton 요소를 찾을 수 없습니다.");
                        }
                    }, 500);  // 버튼이 렌더링될 시간을 확보
                })
                .catch(error => {
                    console.error("❌ 매치 데이터를 불러오는 중 오류 발생:", error);
                });
        }



        function openFullPopup() {
            document.getElementById('fullPopup').classList.remove('hidden');
        }

        function closeFullPopup() {
            document.getElementById('fullPopup').classList.add('hidden');
        }

        function openSuccessPopup() {
            document.getElementById('successPopup').classList.remove('hidden');
        }

        function closeSuccessPopup() {
            document.getElementById('successPopup').classList.add('hidden');
        }

        document.addEventListener("DOMContentLoaded", function () {
            loadMatchDetails();  // 매치 정보 불러오기
            loadComments();  // 🚀 페이지 로드 시 댓글 불러오기 추가
        });

    </script>
</body>

</html>