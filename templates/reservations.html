<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì˜ˆì•½ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="bg-gray-100 flex justify-center items-center min-h-screen">
    <div class="w-full max-w-md p-6">
      <!-- ìƒë‹¨ ì˜ì—­: ë¡œê³  + ë„¤ë¹„ê²Œì´ì…˜ -->
      <div class="flex flex-col items-center pt-8">
        <!-- ë¡œê³  -->
        <div class="mb-4">
          <a href="/">
            <img
              src="{{ url_for('static', filename='jungledunk.png') }}"
              alt="Jungle Dunk Logo"
              class="h-20 w-auto mx-auto"
            />
          </a>
        </div>

        <!-- ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¥¸ ë²„íŠ¼ -->
        <div id="nav-center" class="flex items-center space-x-2 mb-8">
          <!-- ê²ŒìŠ¤íŠ¸ ìƒíƒœ -->
          <div id="guest-buttons" class="flex space-x-2">
            <a
              href="/login"
              class="px-3 py-1 bg-[#15857A] text-white rounded shadow hover:bg-[#15857A]"
              >ë¡œê·¸ì¸</a
            >
            <a
              href="/register"
              class="px-3 py-1 bg-blue-500 text-white rounded shadow hover:bg-blue-600"
              >íšŒì›ê°€ì…</a
            >
          </div>
          <!-- ë¡œê·¸ì¸ ëœ ìƒíƒœ -->
          <div id="user-buttons" class="hidden flex items-center space-x-2">
            <span
              id="username-display"
              class="text-sm font-bold text-gray-800"
            ></span>
            <a
              href="/reservations"
              class="text-[#15857A] text-sm hover:text-[#0E6153]"
            >ë‚´ ì˜ˆì•½í˜„í™©</a>

            <button
              onclick="logout()"
              class="text-red-500 text-sm hover:text-red-600"
            >ë¡œê·¸ì•„ì›ƒ</button>
          </div>
        </div>
      </div>

      <div
        class="bg-gray-300 text-lg font-bold px-6 py-3 rounded-lg text-center"
      >
        ë‚´ ì˜ˆì•½í˜„í™©
      </div>

      <!-- ì˜ˆì•½ ë¦¬ìŠ¤íŠ¸ -->
      <div id="reservations-container" class="mt-6 space-y-4">
        {% if reservations %} {% for res in reservations %} {% set match =
        res.match %}
        <div
          class="bg-white border border-gray-300 shadow-md rounded-lg p-4 flex justify-between items-center"
        >
          <div class="w-1/4 text-left">
            <p class="text-sm text-gray-500">ë‚ ì§œ: {{ match.date }}</p>
            <p class="text-lg font-semibold text-gray-800">
              {{ match.time_start }} ~ {{ match.time_end }}
            </p>
          </div>

          <div class="w-2/4 text-sm text-gray-700">
            <p>ì¸ì› : {{ match.current_players }}/{{ match.max_players }}</p>
            <p>#{{ match.court_type }} #{{ match.memo }}</p>
            <p class="text-xs text-gray-500">
              ì˜ˆì•½ì: {{ match.creator_name }}
            </p>
          </div>
          <div class="w-1/4 flex flex-col items-end space-y-2">
            {% if match.creator_id == current_user_id %}openCancelPopup
            
            <button
              onclick="openPopup('{{ match._id }}')"
              class="bg-red-500 text-white w-full text-center px-4 py-2 text-sm rounded-lg hover:bg-red-600 transition mx-auto block"
            >ì‚­ì œí•˜ê¸°</button>

            <a
              href="/player_list/{{ match._id }}"
              class="bg-[#15857A] text-white w-full text-center px-4 py-2 text-sm rounded-lg hover:bg-[#106156] transition"
            >ì˜ˆì•½ì ëª…ë‹¨</a>

            {% else %}
            <button
              onclick="openCancelPopup('{{ match._id }}', '{{ res.reservation_id }}')"
              class="bg-orange-500 text-white w-full text-center px-4 py-2 text-sm rounded-lg hover:bg-orange-600 transition"
            >
              ì·¨ì†Œí•˜ê¸°
            </button>
            {% endif %}
          </div>
        </div>
        {% endfor %} {% else %}
        <p class="text-center text-gray-500">ì˜ˆì•½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endif %}
      </div>

      <!-- ì‚­ì œ í™•ì¸ íŒì—… (ì‚­ì œ ì‚¬ìœ  ì…ë ¥) -->
      <div
        id="popup"
        class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center"
      >
        <div class="bg-white p-6 rounded-lg shadow-lg w-80 text-center">
          <p class="text-lg font-bold">ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
          <p class="text-m font-semibold">ì „ì²´ ì°¸ì—¬ìì—ê²Œ ì‚­ì œ ì‚¬ìœ ì™€ í•¨ê»˜</p>
          <p class="text-m font-semibold">ì‚­ì œ ì•ˆë‚´ ë©”ì¼ì´ ë°œì†¡ë©ë‹ˆë‹¤.</p>
          <textarea
            id="deleteReason"
            class="w-full border rounded-lg p-2 mt-2"
            placeholder="ì‚­ì œ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
          ></textarea>
          <div class="mt-4 flex justify-center space-x-4">
            <button
              id="confirmDelete"
              onclick="deleteReservation()"
              class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition"
            >
              í™•ì¸
            </button>
            <button
              onclick="closePopup()"
              class="bg-gray-300 px-4 py-2 rounded-lg hover:bg-gray-400 transition"
            >
              ì·¨ì†Œ
            </button>
          </div>
        </div>
      </div>

      <!-- ë¡œë”© íŒì—… (ì´ë©”ì¼ ì „ì†¡ ì¤‘ í‘œì‹œ) -->
      <div
        id="loadingPopup"
        class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center"
      >
        <div class="bg-white p-6 rounded-lg shadow-lg w-80 text-center">
          <p class="text-lg font-semibold">ì•ˆë‚´ ë©”ì¼ ë°œì†¡ì¤‘ì…ë‹ˆë‹¤...</p>
          <div class="flex justify-center mt-4">
            <!-- Tailwindì˜ animate-spinì„ ì‚¬ìš©í•œ ìŠ¤í”¼ë„ˆ -->
            <div
              class="w-6 h-6 border-4 border-blue-500 border-dashed rounded-full animate-spin"
            ></div>
          </div>
        </div>
      </div>

      <!-- ì‚­ì œ ì™„ë£Œ íŒì—… -->
      <div
        id="confirmPopup"
        class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center"
      >
        <div class="bg-white p-6 rounded-lg shadow-lg w-80 text-center">
          <p class="text-lg font-semibold">ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
          <p class="text-sm text-gray-600 mt-2">ì‚­ì œ ì‚¬ìœ :</p>
          <p
            id="deleteReasonText"
            class="text-sm text-gray-800 font-medium mt-1"
          ></p>
          <div class="mt-4 flex justify-center">
            <button
              onclick="closeConfirmPopup()"
              class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition"
            >
              í™•ì¸
            </button>
          </div>
        </div>
      </div>

      <!-- ì˜ˆì•½ ì·¨ì†Œ íŒì—… -->
      <div
        id="cancelPopup"
        class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center"
      >
        <div class="bg-white p-6 rounded-lg shadow-lg w-80 text-center">
          <p class="text-lg font-semibold">ì •ë§ ì˜ˆì•½ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
          <div class="mt-4 flex justify-center space-x-4">
            <!-- ì·¨ì†Œ í™•ì¸ ë²„íŠ¼ -->
            <button
              id="confirmCancel"
              class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition"
            >
              í™•ì¸
            </button>
            <!-- ì·¨ì†Œ ë²„íŠ¼ -->
            <button
              onclick="closeCancelPopup()"
              class="bg-gray-300 px-4 py-2 rounded-lg hover:bg-gray-400 transition"
            >
              ì·¨ì†Œ
            </button>
          </div>
        </div>
      </div>

      <!-- ì»¤ìŠ¤í…€ ì•Œë¦¼ íŒì—… -->
      <div
        id="customAlertPopup"
        class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center"
      >
        <div class="bg-white p-6 rounded-lg shadow-lg w-80 text-center">
          <p id="customAlertMessage" class="text-lg"></p>
          <div class="mt-4 flex justify-center">
            <button
              onclick="closeCustomAlert()"
              class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition"
            >
              í™•ì¸
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      function navigateIfLoggedIn(targetUrl) {
        const token = localStorage.getItem('token');
        if (token) {
          window.location.href = targetUrl;
        } else {
          window.location.href = '/login';
        }
      }
      let reservationsData = []; // ì „ì²´ ì˜ˆì•½ ë°ì´í„° ì €ì¥
      let currentPage = 1;
      const itemsPerPage = 3;
      let currentUserId = ''; // ì „ì—­ ë³€ìˆ˜ì— í˜„ì¬ ì‚¬ìš©ì ì•„ì´ë”” ì €ì¥

      // í˜ì´ì§€ë¥¼ ë³€ê²½í•˜ëŠ” í•¨ìˆ˜
      function changePage(page) {
        currentPage = page;
        renderReservationsPage(currentPage);
      }

      // í˜„ì¬ í˜ì´ì§€ì— í•´ë‹¹í•˜ëŠ” ì˜ˆì•½ ë°ì´í„°ë¥¼ ë Œë”ë§í•˜ê³  í˜ì´ì§€ë„¤ì´ì…˜ ì»¨íŠ¸ë¡¤ ì¶”ê°€
      function renderReservationsPage(page) {
        const container = document.getElementById('reservations-container');
        let html = '';
        const totalPages = Math.ceil(reservationsData.length / itemsPerPage);

        if (reservationsData.length === 0) {
          html =
            '<p class="text-center text-gray-500">ì˜ˆì•½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        } else {
          const startIndex = (page - 1) * itemsPerPage;
          const endIndex = startIndex + itemsPerPage;
          const pageReservations = reservationsData.slice(startIndex, endIndex);

          pageReservations.forEach((res) => {
            const match = res.match;
            html += `
          <div class="bg-white border border-gray-300 shadow-md rounded-lg p-4 flex justify-between items-center">
              <!-- ì™¼ìª½ ìƒì„¸ ì •ë³´ -->
              <div class="flex-grow cursor-pointer" onclick="navigateToComment('${match.match_id}')">
              <!-- ë‚ ì§œ ì •ë³´ -->
              <p class="text-sm text-gray-500 text-left">ğŸ“… ë‚ ì§œ: ${match.date}</p>
              <!-- ì‹œê°„ ì •ë³´ -->
              <div class="flex-none text-lg font-bold whitespace-nowrap text-gray-900 text-left">
                â° ${match.time_start} ~ ${match.time_end}
              </div>
              <!-- ì¸ì› ë° ê¸°íƒ€ ì •ë³´ -->
              <div class="w-2/4 text-base text-gray-700 mt-2 text-left">
              <p class="font-semibold">ğŸ‘¥ ì¸ì›: ${match.current_players} / ${match.max_players}</p>
              <p class="text-gray-600">ğŸ€ #${match.court_type}, âœï¸ #${match.memo}</p>
              <p class="text-sm text-gray-500 font-medium">ğŸ“Œ ì˜ˆì•½ì: ${match.creator_name}</p>
              </div>
          </div>
          <!-- ì˜¤ë¥¸ìª½ ë²„íŠ¼ ì˜ì—­ -->
          <div class="w-1/4 flex flex-col items-end space-y-2">
            ${
              match.creator_id === currentUserId
                ? `
                  <button onclick="openPopup('${match._id}')" class="bg-red-500 text-white w-full text-center px-4 py-2 text-sm rounded-lg hover:bg-red-600 transition mx-auto block">
                    ì‚­ì œí•˜ê¸°
                  </button>
                  <a href="/player_list/${match._id}" class="bg-[#15857A] text-white w-full text-center px-4 py-2 text-sm rounded-lg hover:bg-[#106156] transition">
                    ì˜ˆì•½ì ëª…ë‹¨
                  </a>
                  <button onclick="openCancelPopup('${match._id}', '${res.reservation_id}')" class="bg-orange-500 text-white w-full text-center px-4 py-2 text-sm rounded-lg hover:bg-orange-600 transition">
                    ì·¨ì†Œí•˜ê¸°
                  </button>
                `
                : `
                  <button onclick="openCancelPopup('${match._id}', '${res.reservation_id}')" class="bg-red-500 text-white w-full text-center px-4 py-2 text-sm rounded-lg hover:bg-red-600 transition mx-auto block">
                    ì·¨ì†Œí•˜ê¸°
                  </button>
                `
            }
          </div>
        </div>
      `;
          });

          // í˜ì´ì§€ë„¤ì´ì…˜ ì»¨íŠ¸ë¡¤ ì¶”ê°€
          html += `<div class="mt-4 flex justify-center space-x-2">`;
          if (page > 1) {
            html += `<button onclick="changePage(${
              page - 1
            })" class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400">ì´ì „</button>`;
          }
          html += `<span class="px-3 py-1">Page ${page} of ${totalPages}</span>`;
          if (page < totalPages) {
            html += `<button onclick="changePage(${
              page + 1
            })" class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400">ë‹¤ìŒ</button>`;
          }
          html += `</div>`;
        }
        container.innerHTML = html;
      }

      // ê¸°ì¡´ fetchReservations í•¨ìˆ˜ì—ì„œ AJAXë¡œ ì˜ˆì•½ ë°ì´í„°ë¥¼ ë°›ì•„ì˜¤ë©´ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ í›„ ì²« í˜ì´ì§€ ë Œë”ë§
      function fetchReservations() {
        const token = localStorage.getItem('token');
        if (!token) {
          window.location.href = '/login';
          return;
        }
        fetch('/api/reservations', {
          headers: {
            Authorization: 'Bearer ' + token,
          },
        })
          .then((response) => response.json())
          .then((data) => {
            console.log('ì˜ˆì•½ ë°ì´í„° ì‘ë‹µ:', data);
            reservationsData = data.reservations || [];
            currentUserId = data.current_user_id;
            currentPage = 1;
            renderReservationsPage(currentPage);
          })
          .catch((error) => {
            console.error('ì˜ˆì•½ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            document.getElementById('reservations-container').innerHTML =
              '<p class="text-center text-red-500">ì˜ˆì•½ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ</p>';
          });
      }

      // DOMContentLoaded ì´ë²¤íŠ¸ í›„ ì‹¤í–‰ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
      document.addEventListener('DOMContentLoaded', function () {
        const token = localStorage.getItem('token');
        if (!token) {
          window.location.href = '/login';
          return;
        }
        const payload = JSON.parse(atob(token.split('.')[1]));
        const username = payload.username;
        document.getElementById(
          'username-display'
        ).textContent = `${username}ë‹˜!`;
        document.getElementById('guest-buttons').classList.add('hidden');
        document.getElementById('user-buttons').classList.remove('hidden');

        // ì˜ˆì•½ ë°ì´í„°ë¥¼ AJAXë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
        fetchReservations();
      });

      function logout() {
        localStorage.removeItem('token');
        showCustomAlert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');

        window.location.href = '/';
      }

      function navigateToComment(matchId) {
        navigateIfLoggedIn('/comment?match_id=' + matchId);
      }

      function deleteReservation() {
        let reason = document.getElementById('deleteReason').value;
        if (reason.trim() === '') {
          showCustomAlert('ì‚­ì œ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }
        // confirmDelete ë²„íŠ¼ì— ì €ì¥ëœ matchId ê°€ì ¸ì˜¤ê¸°
        let matchId = document
          .getElementById('confirmDelete')
          .getAttribute('data-id');
        if (!matchId) {
          showCustomAlert('ë§¤ì¹˜ IDê°€ ì—†ìŠµë‹ˆë‹¤..');
          return;
        }
        // ê¸°ì¡´ ì‚­ì œ íŒì—…ì„ ë‹«ê³  ë¡œë”© íŒì—… í‘œì‹œ
        closePopup();
        document.getElementById('loadingPopup').classList.remove('hidden');

        // ì„œë²„ì˜ /cancel_match/<matchId> ì—”ë“œí¬ì¸íŠ¸ë¡œ POST ìš”ì²­
        fetch(`/cancel_match/${matchId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ reason: reason }),
        })
          .then((response) => response.json())
          .then((data) => {
            console.log('ì˜ˆì•½ ë°ì´í„° ì‘ë‹µ:', data);
            reservationsData = data.reservations || [];
            currentUserId = data.current_user_id;
            currentPage = 1;
            renderReservationsPage(currentPage);
          })
          .catch((error) => {
            console.error('ì˜ˆì•½ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            document.getElementById('reservations-container').innerHTML =
              '<p class="text-center text-red-500">ì˜ˆì•½ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ</p>';
          });
      }

      function openPopup(matchId) {
        // matchIdë¥¼ confirmDelete ë²„íŠ¼ì˜ data-idì— ì €ì¥
        document
          .getElementById('confirmDelete')
          .setAttribute('data-id', matchId);
        // íŒì—…ì„ í‘œì‹œí•©ë‹ˆë‹¤.
        document.getElementById('popup').classList.remove('hidden');
      }

      function closePopup() {
        document.getElementById('popup').classList.add('hidden');
        document.getElementById('deleteReason').value = ''; // ì…ë ¥ ì´ˆê¸°í™”
      }

      function openCancelPopup(matchId, reservationId) {
        if (confirm('ì •ë§ ì˜ˆì•½ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          fetch(`/cancel_reservation/${reservationId}`, {
            method: 'POST',
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.message === 'ì˜ˆì•½ ì·¨ì†Œ ì„±ê³µ!') {
                showCustomAlert('ì˜ˆì•½ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                fetchReservations();
              } else {
                showCustomAlert('ì‚­ì œ ì‹¤íŒ¨: ' + data.message);
              }
            })
            .catch((error) => {
              console.error('ì‚­ì œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
              showCustomAlert('ì‚­ì œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
          // íŒì—… ë‹«ê¸°
          closePopup();
        }
      }

      function openConfirmPopup() {
        document.getElementById('confirmPopup').classList.remove('hidden');
      }

      function closeConfirmPopup() {
        document.getElementById('confirmPopup').classList.add('hidden');
      }

      function showCustomAlert(message) {
        document.getElementById('customAlertMessage').textContent = message;
        document.getElementById('customAlertPopup').classList.remove('hidden');
      }

      function closeCustomAlert() {
        document.getElementById('customAlertPopup').classList.add('hidden');
      }
    </script>
  </body>
</html>
